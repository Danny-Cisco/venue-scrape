<script>
	import SoldOut from '$lib/components/ui/SoldOut.svelte';
	import { getWeekday, getDay, getMonth, getYear, getTime, getTimeZone } from '$lib/utils/date.ts';
	export let gig = {};

	export let showDescription = false;

	function openBandModal(band) {
		console.log('band clicked 👉 ', band);
	}
</script>

<div class="overflow-y-auto gig-card">
	<div class="w-full gig-details">
		<!-- Genres -->
		<div class="block mt-1">
			<div class="row">
				{#each gig.genres as genre}
					<div class="px-3 py-1 bg-white border-[1px] border-black text-black rounded-full">
						{genre}
					</div>
				{/each}
			</div>
		</div>

		<div class="relative flex items-start w-full gap-4 py-4 border-b border-gray-300">
			<!-- 🎨 Poster -->
			{#if gig.image}
				<img src={gig.image} alt={gig.title} class="object-cover w-32 h-32 rounded" />
			{/if}

			<!-- 📝 Details -->
			<div class="flex flex-col flex-1 min-h-full">
				<!-- Gig Title -->
				<h2 class="text-2xl font-bold text-black">{gig.title}</h2>
				<div class="flex-1"></div>
				<!-- Date + Time -->
				<p class="text-lg font-semibold text-black">
					{getTime(gig.startDate)}, {getWeekday(gig.startDate)}
					{getDay(gig.startDate)}
					{getMonth(gig.startDate)}, {getYear(gig.startDate)}
				</p>

				<!-- Venue -->
				{#if gig.venue}
					<p class="mt-1 font-bold text-gray-700 text-md">
						<u>{gig.venue.name}</u>,
						{#if gig.ticketUrl && gig.ticketUrl !== '#'}
							<a
								href={gig.ticketUrl}
								target="_blank"
								class="absolute bottom-0 right-0 row gig-ticket-button"
								>Ticketing Site <svg
									xmlns="http://www.w3.org/2000/svg"
									fill="none"
									viewBox="0 0 24 24"
									stroke-width="1.5"
									stroke="currentColor"
									class="size-6"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"
									/>
								</svg>
							</a>
						{:else}
							<p class="gig-ticket-free">Free Entry</p>
						{/if}
					</p>
				{/if}
			</div>
		</div>
		<!-- 🎟️ Tickets Section -->
		{#if gig.tickets && gig.tickets.length > 0}
			<div class="flex flex-col max-w-full gap-2 p-2 bg-black">
				{#each gig.tickets as ticket}
					<div
						class="grid [grid-template-columns:3fr_1fr_1fr] w-full max-w-full gap-2 border p-2 rounded"
					>
						<div>{ticket.ticketType}</div>
						<div>${ticket.price}</div>
						{#if ticket.availability === 'SoldOut'}
							<SoldOut />
						{:else}
							<span>{ticket.availability}</span>
						{/if}
					</div>
				{/each}
			</div>
		{/if}

		<h3 class="mt-4 mb-0 font-bold text-black uppercase">Bands</h3>
		<div class="flex flex-col items-start max-w-full text-blue-500 hover:cursor-pointer">
			{#each gig.bandObjects as bandObject}
				<button on:click={openBandModal(bandObject.bandname)}
					>{bandObject.bandname} - {(bandObject.instagram?.followersCount / 1000).toFixed(
						1
					)}k</button
				>
			{/each}
		</div>
		<h3 class="mt-4 mb-0 font-bold text-black uppercase">Description</h3>

		<div>
			<p
				class="text-sm text-gray-800 transition-all duration-300 ease-in-out gig-description"
				class:line-clamp-3={!showDescription}
			>
				{gig.description}
			</p>

			{#if gig.description.length > 120}
				<button
					on:click={() => (showDescription = !showDescription)}
					class="mt-1 text-sm text-blue-600 underline hover:text-blue-800"
				>
					{showDescription ? 'Show less' : 'Show more'}
				</button>
			{/if}
		</div>
	</div>
</div>

<style>
	.gig-card {
		display: flex;
		flex-direction: column;
		align-items: end;
		gap: 1rem;
		background-color: #fff;

		max-width: 900px;

		padding: 2rem;
		height: 100%;
	}

	.gig-image {
		width: 100%;
		max-width: 300px;
		height: auto;
		border-radius: 0.5rem;
		object-fit: cover;
	}

	.gig-details {
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}

	.gig-title {
		font-size: 1.5rem;
		font-weight: 700;
		color: #222;
	}

	.gig-datetime {
		font-size: 1rem;
		color: #444;
	}

	.gig-description {
		white-space: pre-wrap;
		font-size: 1rem;
		color: #333;
		line-height: 1.5;
	}

	.gig-ticket-free {
		color: green;
		font-weight: bold;
		margin-top: 1rem;
	}
</style>
